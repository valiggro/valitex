{% extends 'layout.html.twig' %}

{% block title %}
	eFactură
{% endblock %}

{% block content %}
	<form id="filters">
		<div class="mt-3 row">
			<div class="col">
				<select name="supplierId" class="form-control" onchange="jQuery('#filters').submit();">
					<option value="">Distribuitor</option>
					{% for _id,_name in suppliers %}
						<option value="{{ _id }}" {{ _id == app.request.query.get('supplierId') ? 'selected' }}>{{ _name }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col">
				<div class="input-group">
					{% set _prev = app.request.query.get('issueDate')|date_modify("-1 day")|date('Y-m-d') %}
					{% set _next = app.request.query.get('issueDate')|date_modify("+1 day")|date('Y-m-d') %}
					<span class="input-group-text" style="cursor: pointer;" onclick="jQuery('input[name=issueDate]').val('{{ _prev }}'); jQuery('#filters').submit();">
						<i class="bi bi-chevron-left"></i>
					</span>
					<input type="date" name="issueDate" value="{{ app.request.query.get('issueDate') }}" class="form-control text-center" onchange="jQuery('#filters').submit();" onfocus="this.showPicker();" onclick="this.showPicker();">
					<span class="input-group-text" style="cursor: pointer;" onclick="jQuery('input[name=issueDate]').val('{{ _next }}'); jQuery('#filters').submit();">
						<i class="bi bi-chevron-right"></i>
					</span>
				</div>
			</div>
			<div class="col">
				<select name="noteNumber" class="form-control text-center" onchange="jQuery('#filters').submit();">
					<option value="">NIR</option>
					{% for v,l in {'yes': 'da', 'no': 'nu'} %}
						<option value="{{ v }}" {{ v == app.request.query.get('noteNumber') ? 'selected' }}>{{ l }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col">
				<div class="input-group">
					{% set _page = app.request.query.get('page') ?: 1 %}
					{% set _last = (einvoices.count / einvoices.query.maxResults)|round ?: 1 %}
					{% if 1 < _page %}
						<span class="input-group-text" style="cursor: pointer;" onclick="jQuery('select[name=page]').val('{{ _page - 1 }}'); jQuery('#filters').submit();">
							<i class="bi bi-chevron-left"></i>
						</span>
					{% else %}
						<span class="input-group-text">
							<i class="bi bi-chevron-left"></i>
						</span>
					{% endif %}
					<select name="page" class="form-control text-center" onchange="jQuery('#filters').submit();">
						{% for p in range(1, _last) %}
							<option value="{{ p }}" {{ p == _page ? 'selected' }}>{{ p ~ '/' ~ _last }}</option>
						{% endfor %}
					</select>
					{% if _page < _last %}
						<span class="input-group-text" style="cursor: pointer;" onclick="jQuery('select[name=page]').val('{{ _page + 1 }}');jQuery('#filters').submit();">
							<i class="bi bi-chevron-right"></i>
						</span>
					{% else %}
						<span class="input-group-text">
							<i class="bi bi-chevron-right"></i>
						</span>
					{% endif %}
				</div>
			</div>
		</div>
	</form>
	<table class="table table-bordered mt-3">
		<thead>
			<tr>
				<th>Încărcată</th>
				<th>Distribuitor</th>
				<th class="text-center">Număr</th>
				<th class="text-center">Emisă</th>
				<th class="text-center">Total</th>
				<th class="text-center">Factură</th>
				<th class="text-center" colspan="3">NIR</th>
			</tr>
		</thead>
		<tbody>
			{% for einvoice in einvoices %}
				<tr class="text-nowrap">
					<td class="text-center">{{ einvoice.message.creationDate|slice(0, 4) }}-{{ einvoice.message.creationDate|slice(4, 2) }}-{{ einvoice.message.creationDate|slice(6, 2) }}</td>
					<td class="text-wrap">{{ einvoice.supplierName }}</td>
					<td class="text-end">{{ einvoice.number }}</td>
					<td class="text-center">{{ einvoice.issueDate|date('Y-m-d') }}</td>
					<td class="text-end">{{ einvoice.payableAmount }}</td>
					<td class="p-1">
						{% if einvoice.hasPdf %}
							<a href="{{ path('app_einvoice_pdf', {'id': einvoice.id}) }}" class="btn btn-light btn-sm d-block" target="_blank">
								<i class="bi bi-printer"></i>
								Factură
							</a>
						{% endif %}
					</td>
					<td class="p-1">
						{% if einvoice.hasXml %}
							{% if einvoice.noteNumber %}
								<a href="{{ path('app_note_print', {'id': einvoice.id, 'redirect': app.request.uri}) }}" class="btn btn-light btn-sm d-block">
									<i class="bi bi-printer"></i>
									Notă
								</a>
							{% else %}
								<a href="{{ path('app_note_form', {'id': einvoice.id, 'redirect': app.request.uri}) }}" class="btn btn-success btn-sm d-block">
									<i class="bi bi-plus-circle"></i>
									Notă
								</a>
							{% endif %}
						{% endif %}
					</td>
					<td class="text-end">
						{% if einvoice.noteNumber %}
							{{ einvoice.noteNumber }}
						{% endif %}
					</td>
					<td class="p-1">
						{% if einvoice.noteNumber %}
							<a href="{{ path('app_note_remove', {'id': einvoice.id, 'redirect': app.request.uri}) }}" class="btn btn-danger btn-sm d-block">
								<i class="bi bi-trash3"></i>
							</a>
						{% endif %}
					</td>
				</tr>
			{% endfor %}
		</tbody>
	</table>
{% endblock %}
